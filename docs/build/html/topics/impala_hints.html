<!DOCTYPE html
  SYSTEM "about:legacy-compat">
<html lang="en"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta charset="UTF-8"><meta name="copyright" content="(C) Copyright 2017"><meta name="DC.rights.owner" content="(C) Copyright 2017"><meta name="DC.Type" content="concept"><meta name="DC.Relation" scheme="URI" content="../topics/impala_select.html"><meta name="prodname" content="Impala"><meta name="prodname" content="Impala"><meta name="version" content="Impala 2.8.x"><meta name="version" content="Impala 2.8.x"><meta name="DC.Format" content="XHTML"><meta name="DC.Identifier" content="hints"><link rel="stylesheet" type="text/css" href="../commonltr.css"><title>Query Hints in Impala SELECT Statements</title></head><body id="hints"><main role="main"><article role="article" aria-labelledby="ariaid-title1">

  <h1 class="title topictitle1" id="ariaid-title1">Query Hints in Impala SELECT Statements</h1>
  
  

  <div class="body conbody">

    <p class="p">
      
      The Impala SQL dialect supports query hints, for fine-tuning the inner workings of queries. Specify hints as
      a temporary workaround for expensive queries, where missing statistics or other factors cause inefficient
      performance.
    </p>

    <p class="p">
      Hints are most often used for the most resource-intensive kinds of Impala queries:
    </p>

    <ul class="ul">
      <li class="li">
        Join queries involving large tables, where intermediate result sets are transmitted across the network to
        evaluate the join conditions.
      </li>

      <li class="li">
        Inserting into partitioned Parquet tables, where many memory buffers could be allocated on each host to
        hold intermediate results for each partition.
      </li>
    </ul>

    <p class="p">
        <strong class="ph b">Syntax:</strong>
      </p>

    <p class="p">
      You can represent the hints as keywords surrounded by <code class="ph codeph">[]</code> square brackets; include the
      brackets in the text of the SQL statement.
    </p>

<pre class="pre codeblock"><code>SELECT STRAIGHT_JOIN <var class="keyword varname">select_list</var> FROM
<var class="keyword varname">join_left_hand_table</var>
  JOIN [{BROADCAST|SHUFFLE}]
<var class="keyword varname">join_right_hand_table</var>
<var class="keyword varname">remainder_of_query</var>;

INSERT <var class="keyword varname">insert_clauses</var>
  [{SHUFFLE|NOSHUFFLE}]
  SELECT <var class="keyword varname">remainder_of_query</var>;
</code></pre>

    <p class="p">
      In <span class="keyword">Impala 2.0</span> and higher, you can also specify the hints inside comments that use
      either the <code class="ph codeph">/* */</code> or <code class="ph codeph">--</code> notation. Specify a <code class="ph codeph">+</code> symbol
      immediately before the hint name.
    </p>

<pre class="pre codeblock"><code>SELECT STRAIGHT_JOIN <var class="keyword varname">select_list</var> FROM
<var class="keyword varname">join_left_hand_table</var>
  JOIN /* +BROADCAST|SHUFFLE */
<var class="keyword varname">join_right_hand_table</var>
<var class="keyword varname">remainder_of_query</var>;

SELECT <var class="keyword varname">select_list</var> FROM
<var class="keyword varname">join_left_hand_table</var>
  JOIN -- +BROADCAST|SHUFFLE
<var class="keyword varname">join_right_hand_table</var>
<var class="keyword varname">remainder_of_query</var>;

INSERT <var class="keyword varname">insert_clauses</var>
  /* +SHUFFLE|NOSHUFFLE */
  SELECT <var class="keyword varname">remainder_of_query</var>;

INSERT <var class="keyword varname">insert_clauses</var>
  -- +SHUFFLE|NOSHUFFLE
  SELECT <var class="keyword varname">remainder_of_query</var>;
</code></pre>

    <p class="p">
        <strong class="ph b">Usage notes:</strong>
      </p>

    <p class="p">
      With both forms of hint syntax, include the <code class="ph codeph">STRAIGHT_JOIN</code>
      keyword immediately after the <code class="ph codeph">SELECT</code> keyword to prevent Impala from
      reordering the tables in a way that makes the hint ineffective.
    </p>

    <p class="p">
      To reduce the need to use hints, run the <code class="ph codeph">COMPUTE STATS</code> statement against all tables involved
      in joins, or used as the source tables for <code class="ph codeph">INSERT ... SELECT</code> operations where the
      destination is a partitioned Parquet table. Do this operation after loading data or making substantial
      changes to the data within each table. Having up-to-date statistics helps Impala choose more efficient query
      plans without the need for hinting. See <a class="xref" href="impala_perf_stats.html#perf_stats">Table and Column Statistics</a> for details and
      examples.
    </p>

    <p class="p">
      To see which join strategy is used for a particular query, examine the <code class="ph codeph">EXPLAIN</code> output for
      that query. See <a class="xref" href="impala_explain_plan.html#perf_explain">Using the EXPLAIN Plan for Performance Tuning</a> for details and examples.
    </p>

    <p class="p">
      <strong class="ph b">Hints for join queries:</strong>
    </p>

    <p class="p">
      The <code class="ph codeph">[BROADCAST]</code> and <code class="ph codeph">[SHUFFLE]</code> hints control the execution strategy for join
      queries. Specify one of the following constructs immediately after the <code class="ph codeph">JOIN</code> keyword in a
      query:
    </p>

    <ul class="ul">
      <li class="li">
        <code class="ph codeph">[SHUFFLE]</code> - Makes that join operation use the <span class="q">"partitioned"</span> technique, which divides
        up corresponding rows from both tables using a hashing algorithm, sending subsets of the rows to other
        nodes for processing. (The keyword <code class="ph codeph">SHUFFLE</code> is used to indicate a <span class="q">"partitioned join"</span>,
        because that type of join is not related to <span class="q">"partitioned tables"</span>.) Since the alternative
        <span class="q">"broadcast"</span> join mechanism is the default when table and index statistics are unavailable, you might
        use this hint for queries where broadcast joins are unsuitable; typically, partitioned joins are more
        efficient for joins between large tables of similar size.
      </li>

      <li class="li">
        <code class="ph codeph">[BROADCAST]</code> - Makes that join operation use the <span class="q">"broadcast"</span> technique that sends the
        entire contents of the right-hand table to all nodes involved in processing the join. This is the default
        mode of operation when table and index statistics are unavailable, so you would typically only need it if
        stale metadata caused Impala to mistakenly choose a partitioned join operation. Typically, broadcast joins
        are more efficient in cases where one table is much smaller than the other. (Put the smaller table on the
        right side of the <code class="ph codeph">JOIN</code> operator.)
      </li>
    </ul>

    <p class="p">
      <strong class="ph b">Hints for INSERT ... SELECT queries:</strong>
    </p>

    <div class="p">
        When inserting into partitioned tables, especially using the Parquet file format, you can include a hint in
        the <code class="ph codeph">INSERT</code> statement to fine-tune the overall performance of the operation and its
        resource usage:
        <ul class="ul">
          <li class="li">
            These hints are available in Impala 1.2.2 and higher.
          </li>

          <li class="li">
            You would only use these hints if an <code class="ph codeph">INSERT</code> into a partitioned Parquet table was
            failing due to capacity limits, or if such an <code class="ph codeph">INSERT</code> was succeeding but with
            less-than-optimal performance.
          </li>

          <li class="li">
            To use these hints, put the hint keyword <code class="ph codeph">[SHUFFLE]</code> or <code class="ph codeph">[NOSHUFFLE]</code>
            (including the square brackets) after the <code class="ph codeph">PARTITION</code> clause, immediately before the
            <code class="ph codeph">SELECT</code> keyword.
          </li>

          <li class="li">
            <code class="ph codeph">[SHUFFLE]</code> selects an execution plan that minimizes the number of files being written
            simultaneously to HDFS, and the number of memory buffers holding data for individual partitions. Thus
            it reduces overall resource usage for the <code class="ph codeph">INSERT</code> operation, allowing some
            <code class="ph codeph">INSERT</code> operations to succeed that otherwise would fail. It does involve some data
            transfer between the nodes so that the data files for a particular partition are all constructed on the
            same node.
          </li>

          <li class="li">
            <code class="ph codeph">[NOSHUFFLE]</code> selects an execution plan that might be faster overall, but might also
            produce a larger number of small data files or exceed capacity limits, causing the
            <code class="ph codeph">INSERT</code> operation to fail. Use <code class="ph codeph">[SHUFFLE]</code> in cases where an
            <code class="ph codeph">INSERT</code> statement fails or runs inefficiently due to all nodes attempting to construct
            data for all partitions.
          </li>

          <li class="li">
            Impala automatically uses the <code class="ph codeph">[SHUFFLE]</code> method if any partition key column in the
            source table, mentioned in the <code class="ph codeph">INSERT ... SELECT</code> query, does not have column
            statistics. In this case, only the <code class="ph codeph">[NOSHUFFLE]</code> hint would have any effect.
          </li>

          <li class="li">
            If column statistics are available for all partition key columns in the source table mentioned in the
            <code class="ph codeph">INSERT ... SELECT</code> query, Impala chooses whether to use the <code class="ph codeph">[SHUFFLE]</code>
            or <code class="ph codeph">[NOSHUFFLE]</code> technique based on the estimated number of distinct values in those
            columns and the number of nodes involved in the <code class="ph codeph">INSERT</code> operation. In this case, you
            might need the <code class="ph codeph">[SHUFFLE]</code> or the <code class="ph codeph">[NOSHUFFLE]</code> hint to override the
            execution plan selected by Impala.
          </li>
        </ul>
      </div>

    <p class="p">
      <strong class="ph b">Suggestions versus directives:</strong>
    </p>

    <p class="p">
      In early Impala releases, hints were always obeyed and so acted more like directives. Once Impala gained join
      order optimizations, sometimes join queries were automatically reordered in a way that made a hint
      irrelevant. Therefore, the hints act more like suggestions in Impala 1.2.2 and higher.
    </p>

    <p class="p">
      To force Impala to follow the hinted execution mechanism for a join query, include the
      <code class="ph codeph">STRAIGHT_JOIN</code> keyword in the <code class="ph codeph">SELECT</code> statement. See
      <a class="xref" href="impala_perf_joins.html#straight_join">Overriding Join Reordering with STRAIGHT_JOIN</a> for details. When you use this technique, Impala does not
      reorder the joined tables at all, so you must be careful to arrange the join order to put the largest table
      (or subquery result set) first, then the smallest, second smallest, third smallest, and so on. This ordering lets Impala do the
      most I/O-intensive parts of the query using local reads on the DataNodes, and then reduce the size of the
      intermediate result set as much as possible as each subsequent table or subquery result set is joined.
    </p>

    <p class="p">
        <strong class="ph b">Restrictions:</strong>
      </p>

    <p class="p">
      Queries that include subqueries in the <code class="ph codeph">WHERE</code> clause can be rewritten internally as join
      queries. Currently, you cannot apply hints to the joins produced by these types of queries.
    </p>

    <p class="p">
      Because hints can prevent queries from taking advantage of new metadata or improvements in query planning,
      use them only when required to work around performance issues, and be prepared to remove them when they are
      no longer required, such as after a new Impala release or bug fix.
    </p>

    <p class="p">
      In particular, the <code class="ph codeph">[BROADCAST]</code> and <code class="ph codeph">[SHUFFLE]</code> hints are expected to be
      needed much less frequently in Impala 1.2.2 and higher, because the join order optimization feature in
      combination with the <code class="ph codeph">COMPUTE STATS</code> statement now automatically choose join order and join
      mechanism without the need to rewrite the query and add hints. See
      <a class="xref" href="impala_perf_joins.html#perf_joins">Performance Considerations for Join Queries</a> for details.
    </p>

    <p class="p">
        <strong class="ph b">Compatibility:</strong>
      </p>

    <p class="p">
      The hints embedded within <code class="ph codeph">--</code> comments are compatible with Hive queries. The hints embedded
      within <code class="ph codeph">/* */</code> comments or <code class="ph codeph">[ ]</code> square brackets are not recognized by or not
      compatible with Hive. For example, Hive raises an error for Impala hints within <code class="ph codeph">/* */</code>
      comments because it does not recognize the Impala hint names.
    </p>

    <p class="p">
        <strong class="ph b">Considerations for views:</strong>
      </p>

    <p class="p">
      If you use a hint in the query that defines a view, the hint is preserved when you query the view. Impala
      internally rewrites all hints in views to use the <code class="ph codeph">--</code> comment notation, so that Hive can
      query such views without errors due to unrecognized hint names.
    </p>

    <p class="p">
        <strong class="ph b">Examples:</strong>
      </p>

    <p class="p">
      For example, this query joins a large customer table with a small lookup table of less than 100 rows. The
      right-hand table can be broadcast efficiently to all nodes involved in the join. Thus, you would use the
      <code class="ph codeph">[broadcast]</code> hint to force a broadcast join strategy:
    </p>

<pre class="pre codeblock"><code>select straight_join customer.address, state_lookup.state_name
  from customer join <strong class="ph b">[broadcast]</strong> state_lookup
  on customer.state_id = state_lookup.state_id;</code></pre>

    <p class="p">
      This query joins two large tables of unpredictable size. You might benchmark the query with both kinds of
      hints and find that it is more efficient to transmit portions of each table to other nodes for processing.
      Thus, you would use the <code class="ph codeph">[shuffle]</code> hint to force a partitioned join strategy:
    </p>

<pre class="pre codeblock"><code>select straight_join weather.wind_velocity, geospatial.altitude
  from weather join <strong class="ph b">[shuffle]</strong> geospatial
  on weather.lat = geospatial.lat and weather.long = geospatial.long;</code></pre>

    <p class="p">
      For joins involving three or more tables, the hint applies to the tables on either side of that specific
      <code class="ph codeph">JOIN</code> keyword. The <code class="ph codeph">STRAIGHT_JOIN</code> keyword ensures that joins are processed
      in a predictable order from left to right. For example, this query joins
      <code class="ph codeph">t1</code> and <code class="ph codeph">t2</code> using a partitioned join, then joins that result set to
      <code class="ph codeph">t3</code> using a broadcast join:
    </p>

<pre class="pre codeblock"><code>select straight_join t1.name, t2.id, t3.price
  from t1 join <strong class="ph b">[shuffle]</strong> t2 join <strong class="ph b">[broadcast]</strong> t3
  on t1.id = t2.id and t2.id = t3.id;</code></pre>

    

    <p class="p">
        <strong class="ph b">Related information:</strong>
      </p>

    <p class="p">
      For more background information about join queries, see <a class="xref" href="impala_joins.html#joins">Joins in Impala SELECT Statements</a>. For
      performance considerations, see <a class="xref" href="impala_perf_joins.html#perf_joins">Performance Considerations for Join Queries</a>.
    </p>
  </div>
<nav role="navigation" class="related-links"><div class="familylinks"><div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../topics/impala_select.html">SELECT Statement</a></div></div></nav></article></main></body></html>