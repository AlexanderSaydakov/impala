<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html
  PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />

<meta name="copyright" content="(C) Copyright 2018" />
<meta name="DC.rights.owner" content="(C) Copyright 2018" />
<meta name="DC.Type" content="concept" />
<meta name="DC.Title" content="MEM_LIMIT Query Option" />
<meta name="DC.Relation" scheme="URI" content="../topics/impala_query_options.html" />
<meta name="prodname" content="Impala" />
<meta name="prodname" content="Impala" />
<meta name="version" content="Impala 3.0.x" />
<meta name="version" content="Impala 3.0.x" />
<meta name="DC.Format" content="XHTML" />
<meta name="DC.Identifier" content="mem_limit" />
<link rel="stylesheet" type="text/css" href="../commonltr.css" />
<title>MEM_LIMIT Query Option</title>
</head>
<body id="mem_limit">


  <h1 class="title topictitle1" id="ariaid-title1">MEM_LIMIT Query Option</h1>

  
  

  <div class="body conbody">

    <p class="p">
      The MEM_LIMIT query option defines the maximum amount of memory a query
      can allocate on each node. The total memory that can be used by a query is
      the <code class="ph codeph">MEM_LIMIT</code> times the number of nodes.
    </p>


    <p class="p">
      There are two levels of memory limit for Impala.
      The <code class="ph codeph">-mem_limit</code> startup option sets an overall limit for the <span class="keyword cmdname">impalad</span> process
      (which handles multiple queries concurrently).
      That limit is typically expressed in terms of a percentage of the RAM available on the host, such as <code class="ph codeph">-mem_limit=70%</code>.
      The <code class="ph codeph">MEM_LIMIT</code> query option, which you set through <span class="keyword cmdname">impala-shell</span>
      or the <code class="ph codeph">SET</code> statement in a JDBC or ODBC application, applies to each individual query.
      The <code class="ph codeph">MEM_LIMIT</code> query option is usually expressed as a fixed size such as <code class="ph codeph">10gb</code>,
      and must always be less than the <span class="keyword cmdname">impalad</span> memory limit.
    </p>


    <p class="p">
      If query processing exceeds the specified memory limit on any node, either the per-query limit or the
      <span class="keyword cmdname">impalad</span> limit, Impala cancels the query automatically.
      Memory limits are checked periodically during query processing, so the actual memory in use
      might briefly exceed the limit without the query being cancelled.
    </p>


    <p class="p">
      <strong class="ph b">Type:</strong> numeric
    </p>


    <p class="p">
      <strong class="ph b">Units:</strong> A numeric argument represents memory size in bytes; you can also use a suffix of <code class="ph codeph">m</code> or <code class="ph codeph">mb</code>
      for megabytes, or more commonly <code class="ph codeph">g</code> or <code class="ph codeph">gb</code> for gigabytes. If you specify a value with unrecognized
      formats, subsequent queries fail with an error.
    </p>


    <p class="p">
      <strong class="ph b">Default:</strong> 0 (unlimited)
    </p>


    <p class="p">
        <strong class="ph b">Usage notes:</strong>
      </p>


    <p class="p">
      The <code class="ph codeph">MEM_LIMIT</code> setting is primarily useful in a high-concurrency setting,
      or on a cluster with a workload shared between Impala and other data processing components.
      You can prevent any query from accidentally using much more memory than expected,
      which could negatively impact other Impala queries.
    </p>


    <p class="p">
      Use the output of the <code class="ph codeph">SUMMARY</code> command in <span class="keyword cmdname">impala-shell</span>
      to get a report of memory used for each phase of your most heavyweight queries on each node,
      and then set a <code class="ph codeph">MEM_LIMIT</code> somewhat higher than that.
      See <a class="xref" href="impala_explain_plan.html#perf_summary">Using the SUMMARY Report for Performance Tuning</a> for usage information about
      the <code class="ph codeph">SUMMARY</code> command.
    </p>


    <p class="p">
        <strong class="ph b">Examples:</strong>
      </p>


    <p class="p">
      The following examples show how to set the <code class="ph codeph">MEM_LIMIT</code> query option
      using a fixed number of bytes, or suffixes representing gigabytes or megabytes.
    </p>


<pre class="pre codeblock"><code>
[localhost:21000] &gt; set mem_limit=3000000000;
MEM_LIMIT set to 3000000000
[localhost:21000] &gt; select 5;
Query: select 5
+---+
| 5 |
+---+
| 5 |
+---+

[localhost:21000] &gt; set mem_limit=3g;
MEM_LIMIT set to 3g
[localhost:21000] &gt; select 5;
Query: select 5
+---+
| 5 |
+---+
| 5 |
+---+

[localhost:21000] &gt; set mem_limit=3gb;
MEM_LIMIT set to 3gb
[localhost:21000] &gt; select 5;
+---+
| 5 |
+---+
| 5 |
+---+

[localhost:21000] &gt; set mem_limit=3m;
MEM_LIMIT set to 3m
[localhost:21000] &gt; select 5;
+---+
| 5 |
+---+
| 5 |
+---+
[localhost:21000] &gt; set mem_limit=3mb;
MEM_LIMIT set to 3mb
[localhost:21000] &gt; select 5;
+---+
| 5 |
+---+
</code></pre>

    <p class="p">
      The following examples show how unrecognized <code class="ph codeph">MEM_LIMIT</code>
      values lead to errors for subsequent queries.
    </p>


<pre class="pre codeblock"><code>
[localhost:21000] &gt; set mem_limit=3tb;
MEM_LIMIT set to 3tb
[localhost:21000] &gt; select 5;
ERROR: Failed to parse query memory limit from '3tb'.

[localhost:21000] &gt; set mem_limit=xyz;
MEM_LIMIT set to xyz
[localhost:21000] &gt; select 5;
Query: select 5
ERROR: Failed to parse query memory limit from 'xyz'.
</code></pre>

    <p class="p">
      The following examples shows the automatic query cancellation
      when the <code class="ph codeph">MEM_LIMIT</code> value is exceeded
      on any host involved in the Impala query. First it runs a
      successful query and checks the largest amount of memory
      used on any node for any stage of the query.
      Then it sets an artificially low <code class="ph codeph">MEM_LIMIT</code>
      setting so that the same query cannot run.
    </p>


<pre class="pre codeblock"><code>
[localhost:21000] &gt; select count(*) from customer;
Query: select count(*) from customer
+----------+
| count(*) |
+----------+
| 150000   |
+----------+

[localhost:21000] &gt; select count(distinct c_name) from customer;
Query: select count(distinct c_name) from customer
+------------------------+
| count(distinct c_name) |
+------------------------+
| 150000                 |
+------------------------+

[localhost:21000] &gt; summary;
+--------------+--------+----------+----------+---------+------------+----------+---------------+---------------+
| Operator     | #Hosts | Avg Time | Max Time | #Rows   | Est. #Rows | Peak Mem | Est. Peak Mem | Detail        |
+--------------+--------+----------+----------+---------+------------+----------+---------------+---------------+
| 06:AGGREGATE | 1      | 230.00ms | 230.00ms | 1       | 1          | 16.00 KB | -1 B          | FINALIZE      |
| 05:EXCHANGE  | 1      | 43.44us  | 43.44us  | 1       | 1          | 0 B      | -1 B          | UNPARTITIONED |
| 02:AGGREGATE | 1      | 227.14ms | 227.14ms | 1       | 1          | 12.00 KB | 10.00 MB      |               |
| 04:AGGREGATE | 1      | 126.27ms | 126.27ms | 150.00K | 150.00K    | 15.17 MB | 10.00 MB      |               |
| 03:EXCHANGE  | 1      | 44.07ms  | 44.07ms  | 150.00K | 150.00K    | 0 B      | 0 B           | HASH(c_name)  |
<strong class="ph b">| 01:AGGREGATE | 1      | 361.94ms | 361.94ms | 150.00K | 150.00K    | 23.04 MB | 10.00 MB      |               |</strong>
| 00:SCAN HDFS | 1      | 43.64ms  | 43.64ms  | 150.00K | 150.00K    | 24.19 MB | 64.00 MB      | tpch.customer |
+--------------+--------+----------+----------+---------+------------+----------+---------------+---------------+

[localhost:21000] &gt; set mem_limit=15mb;
MEM_LIMIT set to 15mb
[localhost:21000] &gt; select count(distinct c_name) from customer;
Query: select count(distinct c_name) from customer
ERROR:
Memory limit exceeded
Query did not have enough memory to get the minimum required buffers in the block manager.
</code></pre>

  </div>

<div class="related-links">
<div class="familylinks">
<div class="parentlink"><strong>Parent topic:</strong> <a class="link" href="../topics/impala_query_options.html">Query Options for the SET Statement</a></div>
</div>
</div></body>
</html>